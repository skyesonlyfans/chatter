<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatterBox v6 - Secure P2P Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --accent: #5b7cff;
            --accent-hover: #4a67e8;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border: rgba(255, 255, 255, 0.08);
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .logo { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; }
        
        .version-badge {
            background: var(--accent);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }

        .credit {
            font-size: 0.8rem;
            color: var(--accent);
            margin-left: 12px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .header-actions { display: flex; gap: 0.75rem; }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.1rem;
        }

        .btn-icon:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-icon.active { background: var(--error); color: white; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .main { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 98;
            backdrop-filter: blur(2px);
        }

        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 99;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .form-group { margin-bottom: 1.25rem; }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
        }

        .input:focus {
            border-color: var(--accent);
            background: rgba(91, 124, 255, 0.05);
        }

        .input-code {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            letter-spacing: 0.25rem;
            text-transform: uppercase;
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            text-align: center;
        }

        .status.info { background: rgba(91, 124, 255, 0.1); color: var(--accent); }
        .status.error { background: rgba(239, 68, 68, 0.1); color: var(--error); }
        .status.success { background: rgba(34, 197, 94, 0.1); color: var(--success); }

        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .contact-item {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .contact-item:hover { background: rgba(255, 255, 255, 0.05); }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .contact-avatar {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .contact-name { font-weight: 500; }

        .btn-small {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-small:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
        }

        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        .welcome-icon { font-size: 4rem; margin-bottom: 1.5rem; }
        .welcome-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.75rem; }
        .welcome-text {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 500px;
            line-height: 1.6;
        }

        .chat-interface {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        .chat-interface.active {
            display: flex;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .room-code {
            font-family: 'Courier New', monospace;
            color: var(--accent);
        }

        .chat-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        .toggle {
            width: 42px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active { background: var(--accent); }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active .toggle-slider { transform: translateX(18px); }

        .toggle-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .btn-secondary {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .messages::-webkit-scrollbar { width: 8px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 70%;
            animation: messageIn 0.2s ease;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.mine {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.system {
            align-self: center;
            max-width: 90%;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .message-content { flex: 1; }

        .message-header {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.theirs .message-bubble {
            background: var(--bg-secondary);
            border-bottom-left-radius: 4px;
        }

        .message.mine .message-bubble {
            background: var(--accent);
            border-bottom-right-radius: 4px;
        }

        .message.system .message-bubble {
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .message-file {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-file:hover { background: rgba(0, 0, 0, 0.4); }

        .file-icon { font-size: 1.5rem; }

        .file-info { flex: 1; }

        .file-name {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .input-area {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .input-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message-input {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: inherit;
            resize: none;
            outline: none;
            min-height: 44px;
            max-height: 120px;
        }

        .message-input:focus { border-color: var(--accent); }

        .input-actions { display: flex; gap: 0.5rem; }

        .file-input { display: none; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title { font-size: 1.5rem; font-weight: 700; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .modal-close:hover { background: var(--bg-tertiary); }

        .addon-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .addon-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .addon-info { flex: 1; }

        .addon-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .addon-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .addon-toggle {
            width: 36px;
            height: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .addon-toggle.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .addon-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .addon-toggle.active .addon-toggle-slider {
            transform: translateX(16px);
        }

        /* Hidden audio elements for Voice Chat */
        #audioContainer { display: none; }

        @media (max-width: 768px) {
            .menu-btn { display: block; }
            
            .sidebar {
                position: fixed;
                left: -320px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s ease;
                height: 100vh;
                padding-top: 60px; /* Space for menu button inside header */
            }

            .sidebar.active { left: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
            .sidebar-overlay.active { display: block; }

            .message { max-width: 85%; }
            
            .chat-header { padding: 0.75rem 1rem; }
            .chat-title { font-size: 1rem; }
            .btn-secondary { font-size: 0.75rem; padding: 0.4rem 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
            <div class="logo">
                üí¨ ChatterBox
                <span class="version-badge">v6</span>
            </div>
            <div class="credit">Made by Skye &lt;3</div>
        </div>
        <div class="header-actions">
            <button class="btn-icon" id="addonBtn" title="Addons">üß©</button>
        </div>
    </div>

    <div class="main">
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-tabs">
                <button class="tab active" data-tab="join">Join Room</button>
                <button class="tab" data-tab="contacts">Contacts</button>
            </div>

            <div class="tab-content active" data-content="join">
                <div class="form-group">
                    <label class="label">Nickname</label>
                    <input type="text" class="input" id="nicknameInput" placeholder="Enter your name" maxlength="20">
                </div>

                <div class="form-group">
                    <label class="label">Room Code</label>
                    <input type="text" class="input input-code" id="roomCodeInput" placeholder="ABC123" maxlength="6">
                </div>

                <button class="btn" id="joinBtn">Join Room</button>

                <div id="statusDiv"></div>
            </div>

            <div class="tab-content" data-content="contacts">
                <div id="contactsList" class="contact-list">
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <p>No contacts yet</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Add people from active chats</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="chat-area">
            <div class="welcome" id="welcomeScreen">
                <div class="welcome-icon">üí¨</div>
                <h1 class="welcome-title">Welcome to ChatterBox</h1>
                <p class="welcome-text">
                    Secure peer-to-peer chat rooms with no server storage. 
                    Enter a room code to get started.
                </p>
            </div>

            <div class="chat-interface" id="chatInterface">
                <div class="chat-header">
                    <div class="chat-title">
                        Room: <span class="room-code" id="displayCode"></span>
                    </div>
                    <div class="chat-controls">
                        <div class="toggle-container">
                            <span class="toggle-label">üîí Lock</span>
                            <div class="toggle" id="lockToggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <button class="btn-icon" id="voiceBtn" title="Voice Call">üéôÔ∏è</button>
                        <button class="btn-icon" id="addContactBtn" title="Add Contact">üë§</button>
                        <button class="btn-secondary" id="leaveBtn">Leave</button>
                    </div>
                </div>

                <div class="messages" id="messages"></div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <div class="input-main">
                            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="btn-icon" id="attachBtn" title="Attach File">üìé</button>
                                <input type="file" class="file-input" id="fileInput">
                            </div>
                        </div>
                        <button class="btn-icon" id="sendBtn">‚û§</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="audioContainer"></div>

    <div class="modal" id="addonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üß© Addons</h2>
                <button class="modal-close" id="closeAddonModal">√ó</button>
            </div>
            <div class="addon-list" id="addonList">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Loading addons from GitHub...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ChatterBox Core
        const APP_PREFIX = 'chatterbox-v1-';
        const GITHUB_API = 'https://api.github.com/repos/skyesonlyfans/landr/contents/chatterbox/store';
        
        let peer = null;
        let connections = [];
        let hostConnection = null;
        let myNickname = '';
        let currentRoomCode = '';
        let amIHost = false;
        let isRoomLocked = false;
        let contacts = JSON.parse(localStorage.getItem('chatterbox_contacts') || '[]');
        let loadedAddons = new Set();

        // Voice Chat Variables
        let localStream = null;
        let activeCalls = [];
        let isVoiceActive = false;

        // ChatterBox API
        window.ChatterBoxAPI = {
            sendMessage: (text) => sendChatMessage(text),
            addSystemMessage: (text) => addSystemMessage(text),
            getRoomCode: () => currentRoomCode,
            getNickname: () => myNickname,
            isHost: () => amIHost,
            getConnections: () => connections.length
        };

        // UI Elements
        const nicknameInput = document.getElementById('nicknameInput');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const joinBtn = document.getElementById('joinBtn');
        const statusDiv = document.getElementById('statusDiv');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatInterface = document.getElementById('chatInterface');
        const displayCode = document.getElementById('displayCode');
        const lockToggle = document.getElementById('lockToggle');
        const voiceBtn = document.getElementById('voiceBtn');
        const addContactBtn = document.getElementById('addContactBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const fileInput = document.getElementById('fileInput');
        const addonBtn = document.getElementById('addonBtn');
        const addonModal = document.getElementById('addonModal');
        const closeAddonModal = document.getElementById('closeAddonModal');
        const contactsList = document.getElementById('contactsList');
        
        // Mobile UI Elements
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Mobile Sidebar Toggle
        function toggleSidebar() {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }
        
        menuBtn.onclick = toggleSidebar;
        sidebarOverlay.onclick = toggleSidebar;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
            });
        });

        // Event Listeners
        joinBtn.onclick = joinRoom;
        leaveBtn.onclick = leaveRoom;
        sendBtn.onclick = sendMessage;
        attachBtn.onclick = () => fileInput.click();
        fileInput.onchange = handleFileUpload;
        voiceBtn.onclick = toggleVoice;
        addContactBtn.onclick = addCurrentContact;
        lockToggle.onclick = toggleLock;
        addonBtn.onclick = () => {
            addonModal.classList.add('active');
            loadAddons();
        };
        closeAddonModal.onclick = () => addonModal.classList.remove('active');

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Load contacts
        function renderContacts() {
            if (contacts.length === 0) {
                contactsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <p>No contacts yet</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Add people from active chats</p>
                    </div>
                `;
                return;
            }

            contactsList.innerHTML = contacts.map(contact => `
                <div class="contact-item" onclick="quickJoin('${contact.code}')">
                    <div class="contact-info">
                        <div class="contact-avatar">${contact.name[0].toUpperCase()}</div>
                        <div>
                            <div class="contact-name">${contact.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${contact.code}</div>
                        </div>
                    </div>
                    <button class="btn-small" onclick="event.stopPropagation(); removeContact('${contact.code}')">Remove</button>
                </div>
            `).join('');
        }

        window.quickJoin = function(code) {
            roomCodeInput.value = code;
            if (window.innerWidth <= 768) toggleSidebar(); // Close sidebar on mobile select
            if (nicknameInput.value.trim()) {
                joinRoom();
            } else {
                document.querySelector('[data-tab="join"]').click();
            }
        };

        window.removeContact = function(code) {
            contacts = contacts.filter(c => c.code !== code);
            localStorage.setItem('chatterbox_contacts', JSON.stringify(contacts));
            renderContacts();
        };

        function addCurrentContact() {
            if (!currentRoomCode) return;
            
            const participantNames = Array.from(document.querySelectorAll('.message-sender'))
                .map(el => el.textContent.trim())
                .filter((v, i, a) => a.indexOf(v) === i && v !== 'You');

            if (participantNames.length === 0) {
                showStatus('No other participants to add', 'error');
                return;
            }

            participantNames.forEach(name => {
                if (!contacts.find(c => c.name === name && c.code === currentRoomCode)) {
                    contacts.push({ name, code: currentRoomCode });
                }
            });

            localStorage.setItem('chatterbox_contacts', JSON.stringify(contacts));
            renderContacts();
            showStatus('Contact added!', 'success');
        }

        function showStatus(text, type) {
            statusDiv.innerHTML = `<div class="status ${type}">${text}</div>`;
            if (type === 'success') {
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        }

        function joinRoom() {
            const code = roomCodeInput.value.trim().toUpperCase();
            const nick = nicknameInput.value.trim();

            if (code.length !== 6) {
                showStatus('Room code must be 6 characters', 'error');
                return;
            }
            if (!nick) {
                showStatus('Please enter a nickname', 'error');
                return;
            }

            myNickname = nick;
            currentRoomCode = code;
            joinBtn.disabled = true;
            showStatus('Connecting...', 'info');

            const roomId = APP_PREFIX + code;
            peer = new Peer(roomId, { debug: 0 });

            peer.on('open', () => {
                amIHost = true;
                showChatInterface();
                addSystemMessage('Room created. You are the host.');
                addSystemMessage(`Waiting for others to join with code: ${code}`);

                peer.on('connection', (conn) => {
                    if (isRoomLocked) {
                        conn.close();
                        return;
                    }
                    setupConnection(conn);
                });
                
                // Host listening for incoming audio calls
                peer.on('call', (call) => {
                    handleIncomingCall(call);
                });
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    peer = new Peer();
                    
                    peer.on('open', () => {
                        amIHost = false;
                        const conn = peer.connect(roomId, {
                            metadata: { nickname: myNickname }
                        });
                        
                        conn.on('open', () => {
                            showChatInterface();
                            hostConnection = conn;
                            setupConnection(conn);
                            addSystemMessage(`Connected to room ${code}`);
                        });

                        conn.on('error', () => {
                            showStatus('Could not connect to room', 'error');
                            joinBtn.disabled = false;
                        });

                        // Client listening for incoming audio calls (from host)
                        peer.on('call', (call) => {
                           handleIncomingCall(call);
                        });
                    });
                } else {
                    showStatus('Connection error: ' + err.type, 'error');
                    joinBtn.disabled = false;
                }
            });
        }

        function setupConnection(conn) {
            if (amIHost) {
                connections.push(conn);
                
                conn.on('data', (data) => {
                    handleData(data, conn);
                });

                conn.on('close', () => {
                    const nick = conn.metadata?.nickname || 'Unknown';
                    addSystemMessage(`${nick} left the room`);
                    connections = connections.filter(c => c !== conn);
                });
                
                conn.on('open', () => {
                    addSystemMessage(`${conn.metadata?.nickname || 'Someone'} joined the room`);
                    // If I am voice active, call the new person immediately
                    if (isVoiceActive && localStream) {
                         const call = peer.call(conn.peer, localStream);
                         activeCalls.push(call);
                    }
                });
            } else {
                conn.on('data', (data) => {
                    handleData(data);
                });
                
                conn.on('close', () => {
                    addSystemMessage('Host disconnected. Room closed.');
                    setTimeout(leaveRoom, 2000);
                });
            }
        }

        function handleData(data, senderConn = null) {
            if (data.type === 'chat') {
                addChatMessage(data.sender, data.text, false, data.timestamp);

                if (amIHost && senderConn) {
                    connections.forEach(conn => {
                        if (conn !== senderConn) {
                            conn.send(data);
                        }
                    });
                }
            } else if (data.type === 'file') {
                addFileMessage(data.sender, data.fileName, data.fileSize, data.fileData, false);

                if (amIHost && senderConn) {
                    connections.forEach(conn => {
                        if (conn !== senderConn) {
                            conn.send(data);
                        }
                    });
                }
            } else if (data.type === 'lock') {
                if (!amIHost) {
                    isRoomLocked = data.locked;
                    lockToggle.classList.toggle('active', data.locked);
                    addSystemMessage(data.locked ? 'üîí Room locked by host' : 'üîì Room unlocked by host');
                }
            }
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            const msgData = {
                type: 'chat',
                sender: myNickname,
                text: text,
                timestamp: Date.now()
            };

            addChatMessage('You', text, true, Date.now());

            if (amIHost) {
                connections.forEach(conn => conn.send(msgData));
            } else if (hostConnection) {
                hostConnection.send(msgData);
            }

            messageInput.value = '';
            messageInput.style.height = 'auto';
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showStatus('File too large (max 10MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const fileData = {
                    type: 'file',
                    sender: myNickname,
                    fileName: file.name,
                    fileSize: file.size,
                    fileData: event.target.result,
                    timestamp: Date.now()
                };

                addFileMessage('You', file.name, file.size, event.target.result, true);

                if (amIHost) {
                    connections.forEach(conn => conn.send(fileData));
                } else if (hostConnection) {
                    hostConnection.send(fileData);
                }
            };
            reader.readAsDataURL(file);
            fileInput.value = '';
        }

        function toggleLock() {
            if (!amIHost) return;
            
            isRoomLocked = !isRoomLocked;
            lockToggle.classList.toggle('active', isRoomLocked);
            
            const lockData = {
                type: 'lock',
                locked: isRoomLocked
            };

            connections.forEach(conn => conn.send(lockData));
            addSystemMessage(isRoomLocked ? 'üîí Room locked' : 'üîì Room unlocked');
        }

        // --- Audio Call Implementation ---

        async function toggleVoice() {
            if (isVoiceActive) {
                // Stop Voice
                stopVoice();
            } else {
                // Start Voice
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                    localStream = stream;
                    isVoiceActive = true;
                    voiceBtn.classList.add('active');
                    addSystemMessage('üéôÔ∏è Microphone activated');

                    // Initiate calls
                    if (amIHost) {
                        // Host calls everyone
                        connections.forEach(conn => {
                            const call = peer.call(conn.peer, localStream);
                            activeCalls.push(call);
                        });
                    } else if (hostConnection) {
                        // Client calls Host
                        const call = peer.call(hostConnection.peer, localStream);
                        activeCalls.push(call);
                    }
                } catch (err) {
                    console.error(err);
                    showStatus('Microphone access denied or error', 'error');
                }
            }
        }

        function stopVoice() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            activeCalls.forEach(call => call.close());
            activeCalls = [];
            isVoiceActive = false;
            voiceBtn.classList.remove('active');
            addSystemMessage('üéôÔ∏è Microphone deactivated');
        }

        function handleIncomingCall(call) {
            // When someone calls us, we answer.
            // If we have a local stream, we send it back.
            // If not, we just answer (one-way audio until we enable mic).
            
            if (localStream) {
                call.answer(localStream);
            } else {
                call.answer(); 
            }
            
            activeCalls.push(call);

            call.on('stream', (remoteStream) => {
                playRemoteStream(remoteStream);
            });
            
            call.on('close', () => {
                activeCalls = activeCalls.filter(c => c !== call);
            });
        }

        function playRemoteStream(stream) {
            // Check if audio element already exists for this stream
            if (document.getElementById(stream.id)) return;

            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.id = stream.id;
            audio.autoplay = true;
            document.getElementById('audioContainer').appendChild(audio);
            
            // Cleanup when stream ends
            stream.getTracks().forEach(track => {
                track.onended = () => {
                    audio.remove();
                };
            });
        }

        // --- End Audio Implementation ---

        function showChatInterface() {
            welcomeScreen.style.display = 'none';
            chatInterface.classList.add('active');
            displayCode.textContent = currentRoomCode;
            statusDiv.innerHTML = '';
            
            // Mobile specific: close sidebar to show chat
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            }
        }

        function leaveRoom() {
            stopVoice(); // Ensure audio stops on leave
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            connections = [];
            hostConnection = null;
            amIHost = false;
            isRoomLocked = false;
            currentRoomCode = '';

            welcomeScreen.style.display = 'flex';
            chatInterface.classList.remove('active');
            messages.innerHTML = '';
            joinBtn.disabled = false;
            lockToggle.classList.remove('active');
            
            // Mobile specific: open sidebar on leave
            if (window.innerWidth <= 768) {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            }
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'message system';
            div.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(text)}</div>
                </div>
            `;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function addChatMessage(sender, text, isMe, timestamp) {
            const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'mine' : 'theirs'}`;
            
            div.innerHTML = `
                ${!isMe ? `<div class="message-avatar">${sender[0].toUpperCase()}</div>` : ''}
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${escapeHtml(sender)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-bubble">${escapeHtml(text)}</div>
                </div>
                ${isMe ? `<div class="message-avatar">${sender[0].toUpperCase()}</div>` : ''}
            `;
            
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function addFileMessage(sender, fileName, fileSize, fileData, isMe) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const sizeStr = formatFileSize(fileSize);
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'mine' : 'theirs'}`;
            
            div.innerHTML = `
                ${!isMe ? `<div class="message-avatar">${sender[0].toUpperCase()}</div>` : ''}
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${escapeHtml(sender)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-bubble">
                        <div class="message-file" onclick="downloadFile('${fileData}', '${escapeHtml(fileName)}')">
                            <div class="file-icon">üìé</div>
                            <div class="file-info">
                                <div class="file-name">${escapeHtml(fileName)}</div>
                                <div class="file-size">${sizeStr}</div>
                            </div>
                        </div>
                    </div>
                </div>
                ${isMe ? `<div class="message-avatar">${sender[0].toUpperCase()}</div>` : ''}
            `;
            
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        window.downloadFile = function(dataUrl, fileName) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = fileName;
            a.click();
        };

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadAddons() {
            const addonList = document.getElementById('addonList');
            addonList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading addons from GitHub...</div>';

            fetch(GITHUB_API)
                .then(response => response.json())
                .then(files => {
                    const jsFiles = files.filter(f => f.name.endsWith('.js'));
                    
                    if (jsFiles.length === 0) {
                        addonList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No addons available yet</div>';
                        return;
                    }

                    addonList.innerHTML = jsFiles.map(file => {
                        const name = file.name.replace('.js', '');
                        const isEnabled = loadedAddons.has(name);
                        
                        return `
                            <div class="addon-card">
                                <div class="addon-info">
                                    <div class="addon-name">${name}</div>
                                    <div class="addon-desc">ChatterBox addon</div>
                                </div>
                                <div class="addon-toggle ${isEnabled ? 'active' : ''}" onclick="toggleAddon('${file.download_url}', '${name}', this)">
                                    <div class="addon-toggle-slider"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(error => {
                    console.error('Error loading addons:', error);
                    addonList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--error);">Failed to load addons</div>';
                });
        }

        window.toggleAddon = function(url, name, toggleEl) {
            if (loadedAddons.has(name)) {
                loadedAddons.delete(name);
                toggleEl.classList.remove('active');
                showStatus('Addon disabled (reload to fully remove)', 'info');
            } else {
                fetch(url)
                    .then(response => response.text())
                    .then(code => {
                        try {
                            eval(code);
                            loadedAddons.add(name);
                            toggleEl.classList.add('active');
                            showStatus('Addon enabled!', 'success');
                        } catch (error) {
                            console.error('Error loading addon:', error);
                            showStatus('Failed to load addon', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching addon:', error);
                        showStatus('Failed to fetch addon', 'error');
                    });
            }
        };

        // Initialize
        renderContacts();
        
        // Load saved nickname
        const savedNick = localStorage.getItem('chatterbox_nickname');
        if (savedNick) nicknameInput.value = savedNick;
        
        nicknameInput.addEventListener('change', () => {
            localStorage.setItem('chatterbox_nickname', nicknameInput.value.trim());
        });
    </script>
</body>
</html>
